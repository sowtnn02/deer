<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å—äºŒåœ˜ å¥”é¹¿å°éšŠå‡ºå¸­ç‹€æ³</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(to bottom right, #f9f9f9, #e6f7ff);
      color: #333;
      padding: 40px 20px;
      margin: 0;
      text-align: center;
    }
    h1 {
      font-size: 1.8em;
      margin-bottom: 30px;
      color: #3c6478;
    }
    .card {
      background-color: white;
      max-width: 500px;
      margin: 0 auto 20px;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      text-align: left;
    }
    .card label {
      display: block;
      margin-bottom: 15px;
      font-weight: bold;
    }
    .card select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
    }
    .card button {
      display: block;
      width: 100%;
      padding: 10px 0;
      margin-top: 10px;
      font-size: 1em;
      color: white;
      background-color: #47a7f5;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .card button:hover {
      background-color: #358ac9;
    }
    ul#results { list-style: none; padding: 0; margin: 0; }
    ul#results li {
      padding: 8px;
      margin: 6px auto;
      max-width: 500px;
      border-radius: 8px;
      background-color: #f1f8ff;
      border-left: 6px solid #47a7f5;
      text-align: left;
      font-size: 1em;
    }
    .status-present { color: green; font-weight: bold; }
    .status-absent  { color: red; font-weight: bold; }
    .status-unfilled { color: gray; font-style: italic; }
  </style>
</head>
<body>
  <h1>ğŸ¦Œ è’é‡ä¿è­·å”æœƒè¦ªå­åœ˜å—äºŒåœ˜ å°éšŠå‡ºå¸­ç‹€æ³ ğŸ¦Œ</h1>
  <div class="card">
    <label for="groupSelect">åœ˜åˆ¥</label>
    <select id="groupSelect">
      <option value="">--è«‹é¸æ“‡åœ˜åˆ¥--</option>
      <option value="å¥”é¹¿åœ˜">å¥”é¹¿åœ˜</option>
    </select>
    <label for="subGroupSelect">åˆ†éšŠ</label>
    <select id="subGroupSelect">
      <option value="">--è«‹å…ˆé¸æ“‡åœ˜åˆ¥--</option>
    </select>
    <button id="searchBtn">æœå°‹</button>
  </div>
  <ul id="results"></ul>

  <script>
    // å®Œæ•´åœ˜éšŠè³‡æ–™
    const teamData = {
      deer: {
        "è‰åŸé¹¿": [
          { family: "68 æ°´ç‰› / æ°´ç«¹", child: "èœ‚é³¥" },
          { family: "19 éš¼ / è‹¦æ¥", child: "é»‘è²“" },
          { family: "33 æ³¥å·´ / è˜†è‘¦", child: "è—ªè²“" },
          { family: "70 æ™¨å…‰ / éº‹é¹¿", child: "ç¾æ´²è™" },
          { family: "3 æ²³é¦¬ / éŠ€æ", child: "å°æµ·é¦¬" },
          { family: "27 å’¬äººè²“ / å¬°å…’æ·š", child: "å¤©å ‚é³¥" }
        ],
        "æ£®æ—é¹¿": [
          { family: "74 èµ°å±±é› / é»ƒèŠ±é¢¨éˆ´æœ¨", child: "å±±ç…" },
          { family: "17 å’¸è±è‰ / è±è§’", child: "å¸é›‰" },
          { family: "19 éš¼ / è‹¦æ¥", child: "ç¬‘ç¿ é³¥" },
          { family: "11 é˜¿å‹ƒå‹’ / æ¥“æ¨¹", child: "ç‰½ç‰›èŠ±" },
          { family: "18 æ©˜å­çš® / æ©˜å­æ¨¹", child: "æ©˜å­è‘‰" }
        ],
        "é«˜åœ°é¹¿": [
          { family: "15 çŸ³è™ / è—èŠ±è—¤", child: "é¢¨ä¿¡å­" },
          { family: "21 è—çœ¼æ·š / éŸ¿éˆ´è±†", child: "ç™½é ­é·¹" },
          { family: "45 é¯¨é ­é¸› / è‰å±¥èŸ²", child: "å°ç…å­" },
          { family: "77 æ¡‚å† è‰ / åŒ—æ¥µæ˜Ÿ", child: "èŠ±æ —é¼ " },
          { family: "69 é­Ÿé­š / æ³¢æ³¢è‰", child: "æµ·æ¡" },
          { family: "50 ç¨»ç©— / ä¸Šå¼¦æœˆ", child: "é¸šéµ¡èº" }
        ],
        "æ¹–æ³Šé¹¿": [
          { family: "65 ç‰å±± / åŒ—æ¥µç‹", child: "è²“ç†Š" },
          { family: "12 åŒ—æ¥µç†Š / ä¼éµ", child: "è™é¯¨" },
          { family: "69 é­Ÿé­š / æ³¢æ³¢è‰", child: "ç¶ ç«¹" },
          { family: "32 ICE / æ —å­", child: "å°åˆºèŸ" },
          { family: "86 çŸ³æ–‘ / ä¸¹æ¥“", child: "æ³¢å¦" }
        ]
      },
    };
    // åœ˜åˆ¥å°æ‡‰ key
    const groupMap = { 'å°èŸ»åœ˜':'ant','ç‚«èœ‚åœ˜':'bee','å¥”é¹¿åœ˜':'deer','ç¿”é·¹åœ˜':'eagle' };

    // ä¸»è¡¨ URL
    const SHEET_URL = 'https://opensheet.elk.sh/13v4T864SSZGSoNiIPGOY12mfzT2q5sbvDrarusC_zLE/é¹¿';

    function convertToOpensheet(url) {
      const m = url.match(/\/d\/([^\/]+)/);
      return m
        ? `https://opensheet.elk.sh/${m[1]}/%E8%A1%A8%E5%96%AE%E5%9B%9E%E6%87%89%201`
        : '';
    }

    async function loadSheetsFromSheet() {
      const res = await fetch(SHEET_URL);
      const raw = await res.json();
      return raw.map(item => ({
        name: `${item.month} ${item.title}`,
        url: convertToOpensheet(item.response_url || item.form_url)
      }));
    }
    const groupSelect    = document.getElementById('groupSelect');
    const subGroupSelect = document.getElementById('subGroupSelect');
    const searchBtn      = document.getElementById('searchBtn');
    const results        = document.getElementById('results');

    // å‹•æ…‹ç”Ÿå‡ºåˆ†éšŠ
    groupSelect.addEventListener('change', () => {
      const key = groupMap[groupSelect.value.trim()];
      subGroupSelect.innerHTML = '<option value="">--è«‹é¸æ“‡åˆ†éšŠ--</option>';
      if (!teamData[key]) return;
      Object.keys(teamData[key]).forEach(sub => {
        const opt = document.createElement('option');
        opt.value = sub;
        opt.textContent = sub;
        subGroupSelect.appendChild(opt);
      });
    });

    // æŸ¥è©¢
    searchBtn.addEventListener('click', async () => {
      results.innerHTML = '';
      const grp  = groupSelect.value.trim();
      const type = subGroupSelect.value.trim();
      if (!grp || !type) {
        return alert('è«‹å…ˆé¸æ“‡åœ˜åˆ¥èˆ‡åˆ†éšŠ');
      }

      const entries = teamData[groupMap[grp]][type] || [];
      const backup  = { bee:'ç‚«èœ‚åœ˜', ant:'å°èŸ»åœ˜', deer:'å¥”é¹¿åœ˜', eagle:'ç¿”é·¹åœ˜' }[groupMap[grp]] || '';
      const sheets  = await loadSheetsFromSheet();

      for (const sheet of sheets) {
        // family|child ç‚º key
        const statusMap = {};
        entries.forEach(e => {
          const k = `${e.family.trim()}|${e.child.trim()}`;
          statusMap[k] = { ...e, filled:false, submitted:false, status:'' };
        });

        let data;
        try {
          const resp = await fetch(sheet.url + '?t=' + Date.now(), { cache:'no-store' });
          data = await resp.json();
        } catch {
          results.innerHTML += `<li>${sheet.name}ï¼šâš ï¸ æŸ¥è©¢å¤±æ•—</li>`;
          continue;
        }

        data.forEach(row => {
          const vals = Object.values(row);
          const fam  = (vals[1]  || '').trim();
          entries.forEach(e => {
            if (fam !== e.family.trim()) return;

            for (let i = 0; i < 3; i++) {
              const child = (vals[2 + i*3] || '').trim();
              const squad = (vals[3 + i*3] || '').trim();
              const st    = (vals[4 + i*3] || 'å‡ºå¸­').trim();

              if ((squad === type || squad === backup) && child === e.child.trim()) {
                const k = `${e.family.trim()}|${e.child.trim()}`;
                statusMap[k] = { ...statusMap[k], filled:true, submitted:true, status:st };
              }
            }
          });
        });

        // æ¨™é¡Œ
        results.innerHTML += `
          <li style="
            background:#e0f0ff;
            padding:10px;
            border-radius:8px;
            font-weight:bold;
            color:#2a5d9f;
            margin-top:20px
          ">
            ${sheet.name}ï½œ${type}å°éšŠå‡ºå¸­ç‹€æ³ï¼š
          </li>`;

        // åˆ—å‡ºæ¯çµ„
        entries.forEach(e => {
          const k = `${e.family.trim()}|${e.child.trim()}`;
          const s = statusMap[k];
          let line;
          if (s.filled) {
            const ok = s.status.includes('å‡ºå¸­');
            line = `${s.family} _ ${s.child}ï¼š<span class="${ok?'status-present':'status-absent'}">${ok?'âœ… å‡ºå¸­':'âŒ è«‹å‡'}</span>`;
          } else if (s.submitted) {
            line = `${s.family} _ ${s.child}ï¼š<span class="status-unfilled">âš ï¸ æœ‰å¡«è¡¨ï¼Œä½†æœªå¡«æ­¤å°éšŠ</span>`;
          } else {
            line = `${s.family} _ ${s.child}ï¼š<span class="status-unfilled">æœªå¡«å¯«</span>`;
          }
          results.innerHTML += `<li>${line}</li>`;
        });
      }
    });
  </script>
</body>
</html>